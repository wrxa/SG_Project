$(function () {
    //初始化动态加载控件
    initialize();
    //注册菜单展开收缩事件
    $(".parentnode_title_symbol").click(function () {
        shrinkage($(this));
    });
    // 注册生成报告方法
    createReport();
    //当没有子节点的div去除样式
    upclass();
	var offset = 300,
    offset_opacity = 1200,
    scroll_top_duration = 700,
    $back_to_top = $('.cd-top');

    $(window).scroll(function(){
        ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
        if( $(this).scrollTop() > offset_opacity ) { 
            $back_to_top.addClass('cd-fade-out');
        }
    });

    $back_to_top.on('click', function(event){
        event.preventDefault();
        $('body,html').animate({
            scrollTop: 0 ,
            }, scroll_top_duration
        );
    });
    // 注册审核事件
    $('#saveCheck').click(function() {
        saveCheck();
    });

    // // 注册进度条按钮
    // var blower = null;
    //     blower = new LoadingBlower("#loadingContainer");
    //     // $("#plus_ten").on("click", function () {
    //         // blower.addProgress(10);
    //         if(blower.progress >= 100){
    //             window.clearInterval(proInt)
    //         }
    $("#down-btn").click(function () {
        window.location.href = "/download_file/"+$("#planId").val()+"";
        $(".progress-my").css("display", "none");
    });
            
});

function test(){
    $(".progress-my").css("display", "block");
    $(".progress-sub").css("display", "block");
}



function saveCheck() {
    $.ajax({
        type: 'POST',
        url: "/planState",
        data: {'planId': $("#planId").val(), "planState": $("#planState").val()},
        dataType: "Json",
        async: false,
        success: function (data) {
           if (data.state == '1') {
                messageToast('success', '审核状态修改成功！',3000);
                // data.planState
                window.location.href = '/converMD/'+$("#planId").val();
           }
           if (data.state == '0') {
                messageToast('error', '您没有审核权限！',2000);
           }
        }
    });
}

//菜单子节点展开关闭
function shrinkage(dom) {
    //改变图片背景
        if (!dom.hasClass('parentnode_title_nochildnode_symbol')) {
            switch (parseInt($(dom).children("b").html())) {
                case 1://关闭
                    $(dom).css('background-image', 'url("../static/img/plus.png")');
                    $(dom).children("b").html("2");
                    $(dom).parent().siblings().hide();
                    break;
                case 2://展开
                    $(dom).css('background-image', 'url("../static/img/minus.png")');
                    $(dom).children("b").html("1");
                    $(dom).parent().siblings().show();
                    break;
                default: break;
            }
        }
}
//循环绑定数据
function databinding(data) {
    //动态创建树形菜单
    var parentnodediv = $(".parentnode");
    for (var i = 0; i < data.tbFuncDic.length; i++) {
        //最上层父节点
        if (data.tbFuncDic[i].ParentID == 0) {
            Cycledata(parentnodediv, data.tbFuncDic[i]);
        }
    }
    //创建子节点
    if (data.tbFuncDic.length > 0) {
        childnodes(data);
    }
}
//创建子节点
function childnodes(data) {
    for (var j = 0; j < $(".parentnode").find(".parentnode_title_name").length; j++) {
        for (var i = 0; i < data.tbFuncDic.length ; i++) {
            if (data.tbFuncDic[i].ParentID == $(".parentnode").find(".parentnode_title_name")[j].id) {
                var parentnodediv = $($(".parentnode").find(".parentnode_title_name")[j]).parent().parent();
                Cycledata(parentnodediv, data.tbFuncDic[i]);
            }
        }
    }
}
 
//绑定数据方法
function Cycledata(parentnodediv, data) {
 
    var parentnode_noe = document.createElement("div");//创建一个div
    parentnode_noe.className = " parentnode_noe";//为div添加class
    parentnodediv.append(parentnode_noe);//将其添加到div末尾
 
    var parentnode_title = document.createElement("div");//创建一个div
    parentnode_title.className = " parentnode_title ";//为div添加class
    parentnode_noe.appendChild(parentnode_title);//将其添加到div末尾
 
    var parentnode_title_symbol = document.createElement("div");//创建一个div
    parentnode_title_symbol.className = "parentnode_title_symbol parentnode_title_fix ";//为div添加class
    parentnode_title.appendChild(parentnode_title_symbol);//将其添加到div末尾
    var b = document.createElement("b");//创建一个b标签
    b.innerHTML = 1;//为b添加内容
    parentnode_title_symbol.appendChild(b);//将其添加到div末尾

    var parentnode_title_name = document.createElement("div");//创建一个div
    parentnode_title_name.className = "parentnode_title_name";//为div添加class
    // 给标题加上锚标记
    parentnode_title_name.innerHTML = "<a href='#a_"+data.FunID+"'>"+ data.FunName+"</a>";
    parentnode_title_name.id = data.FunID;//为div添加ID
    parentnode_title_name.setAttribute("name", data.ParentID);
    parentnode_title.appendChild(parentnode_title_name);//将其添加到div末尾
}
 
//当没有子节点的div去除样式
function upclass() {
    $(".parentnode_title").each(function () {
        var me = $(this);
        if (me.siblings().length == 0) {
            me.find(".parentnode_title_symbol b").css("display", "none");
            me.find(".parentnode_title_symbol").addClass("parentnode_title_nochildnode_symbol").removeClass("parentnode_title_symbol");
        }
    });
}


//初始化控件，调用定义的js
function initialize() {
    $.ajax({
        type: 'POST',
        url: "/initializeMD",
        data: {'planId': $("#planId").val()},
        dataType: "Json",
        async: false,//默认是true，false为同步
        success: function (data) {
            databinding(data.data);//绑定数据
            $("#anchorMark").html(data.html)
        }
    });
}

// 生成报告

function createReport(){
    $('#convert').click(function() {
        $.ajax({
            cache: false,
            type: "POST",
            url: '/convertHtmltoDocx',
            data: {'planId': $("#planId").val()},
            async: false,
            error: function (request) {
                alert("Connection error");
            },
            success: function (data) {
                // $(".progress-sub").css("display", "none");
                // $(".progress").css("display", "block");
                // var blower = null;
                // blower = new LoadingBlower("#loadingContainer");
                // blower.addProgress(100);
                m = messageToast('info', '正在生成word中......',99999999999);
                timer = setInterval(function(){
                $.ajax({
                    cache: false,
                    type: "POST",
                    url: '/getConvertHtmltoDocxState',
                    data: {'planId': $("#planId").val()},
                    async: false,
                    error: function (request) {
                        alert("Connection error");
                    },
                    success: function (data) {
                        if(data.convertHtmltoDocxSate == "0"){
                            clearInterval(timer)
                            document.body.removeChild(m)
                            messageToast('info', '获取下载资源进行中......',2000);
                            setTimeout(test,2000);
                        }
                    }
                });
                },3000);
            }
        });

    })
}